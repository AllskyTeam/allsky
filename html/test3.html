<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Custom Chart Wizard</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <script src="//code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>


  <script src="/js/jquery-loading-overlay/dist/loadingoverlay.min.js"></script>

  <link rel="stylesheet" type="text/css" href="/js/datatables/datatables.min.css" />
  <script type="text/javascript" src="/js/datatables/datatables.js"></script>

  <link rel="stylesheet" href="/js/jquery-variable/jquery-variable.css">
  <script src="/js/jquery-variable/jquery-variable.js"></script>
</head>

<body>


  <script>
    (function ($) {
      $.fn.chartWizard = function (options) {
        const $container = $(this);

        const settings = $.extend({
          onFinish: function (configJson) {
            console.log("Chart config:", configJson);
          }
        }, options)

        if ($('#customChartModal').length) return

        $('body').append(`
          <div id="customChartModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg"><div class="modal-content">
              <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Custom Chart Wizard</h4>
              </div>
              <div class="modal-body">
                <ul class="wizard-breadcrumb">
                  <li class="step-tab active" data-step="1">1. Type</li>
                  <li class="step-tab" data-step="2">2. Series</li>
                  <li class="step-tab" data-step="3">3. Axis</li>
                  <li class="step-tab" data-step="4">4. Preview</li>
                </ul>
                <div class="wizard-step" data-step="1">
                  <div class="chart-type-grid">
                    <div class="chart-type-option" data-type="line"><i class="fa fa-line-chart"></i><div>Line</div></div>
                    <div class="chart-type-option" data-type="bar"><i class="fa fa-bar-chart"></i><div>Bar</div></div>
                    <div class="chart-type-option" data-type="gauge"><i class="fa fa-tachometer"></i><div>Gauge</div></div>
                  </div>
                  <input type="hidden" name="chartType">
                </div>
                <div class="wizard-step" data-step="2" style="display:none;">
                  <div id="series-inputs"></div>
                  <button type="button" class="btn btn-sm btn-default" id="add-series-btn">+ Add series</button>
                </div>
                <div class="wizard-step" data-step="3" style="display:none;">
                  <input id="xAxisTitle" class="form-control" placeholder="X Axis Title"><br>
                  <input id="yAxisTitle" class="form-control" placeholder="Y Axis Title">
                </div>
                <div class="wizard-step" data-step="4" style="display:none;">
                  <div id="customChartPreview" style="width:100%; height:300px;"></div>
                  <div class="panel panel-default chart-options-panel">
                    <div class="panel-heading" data-toggle="collapse" data-target="#chartOptionsPanel">
                      <h5 class="panel-title">Chart Options <span class="caret"></span></h5>
                    </div>
                    <div id="chartOptionsPanel" class="panel-collapse collapse in">
                      <div class="panel-body row">
                        <div class="col-sm-6" id="lineBarOptions">
                          <div class="checkbox"><label><input type="checkbox" id="zoomable"> Zoom X</label></div>
                          <div class="checkbox"><label><input type="checkbox" id="animated-linebar"> Animated</label></div>
                          <div class="checkbox"><label><input type="checkbox" id="smooth-line"> Smooth Line</label></div>
                        </div>
                        <div class="col-sm-6" id="gaugeOptions" style="display:none;">
                          <div class="checkbox"><label><input type="checkbox" id="animated-gauge"> Animated</label></div>
                          <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                            <label>Green max:</label>
                            <input type="number" class="form-control input-sm" id="gaugeGreen" value="33" style="width: 60px;">
                            <label>Yellow max:</label>
                            <input type="number" class="form-control input-sm" id="gaugeYellow" value="66" style="width: 60px;">
                          </div>
                        </div>
                        <div class="col-sm-12">
                          <div class="checkbox"><label><input type="checkbox" id="show-legend" checked> Show Legend</label></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-default wizard-back" disabled>Back</button>
                <button class="btn btn-primary wizard-next">Next</button>
                <button class="btn btn-success wizard-finish" style="display:none;">Finish</button>
              </div>
            </div></div>
          </div>
        `);

        const styleBlock = `
          <style>
            .wizard-step { height: 600px; overflow-y: auto; padding-right: 10px; }
            .modal-body { padding: 15px; height: 600px; overflow: hidden; display: flex; flex-direction: column; }
            .modal-footer, .modal-header { position: sticky; background-color: #fff; z-index: 10; }
            .modal-footer { bottom: 0; border-top: 1px solid #ddd; }
            .modal-header { top: 0; border-bottom: 1px solid #ddd; }
            .series-row { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
            .series-var { flex: 2; } .series-axis, .series-style { flex: 1; } .series-color { width: 40px; }
            .remove-series-btn { background: none; border: none; color: #d9534f; font-size: 18px; cursor: pointer; }
            .wizard-breadcrumb { display: flex; justify-content: space-between; margin: 0 0 15px; border-bottom: 1px solid #ccc; font-size: 13px; }
            .wizard-breadcrumb li { list-style: none; flex: 1; text-align: center; color: #777; cursor: pointer; position: relative; }
            .wizard-breadcrumb li.active { font-weight: bold; color: #337ab7; }
            .wizard-breadcrumb li:not(:last-child)::after { content: ""; position: absolute; top: 50%; right: 0; height: 14px; width: 1px; background: #ccc; transform: translateY(-50%); }
            .chart-type-grid { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 40px; }
            .chart-type-option { width: 120px; height: 120px; text-align: center; padding: 10px; border: 2px solid #ccc; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: 0.2s; }
            .chart-type-option:hover, .chart-type-option.active { border-color: #337ab7; background-color: #eaf3ff; }
            .chart-type-option i { font-size: 32px; color: #555; margin-bottom: 10px; }
          </style>
        `;
        $('head').append(styleBlock);

        // === Wizard Logic ===
        let step = 1;

        function showStep(n) {
          $('.wizard-step').hide();
          $(`.wizard-step[data-step="${n}"]`).show();
          $('.wizard-back').prop('disabled', n === 1);
          $('.wizard-next').toggle(n < 4);
          $('.wizard-finish').toggle(n === 4);
          step = n;
          $('.step-tab').removeClass('active');
          $(`.step-tab[data-step="${n}"]`).addClass('active');
          if (step === 4) generatePreview();
        }

        function generatePreview() {
          const chartType = $('input[name="chartType"]').val();
          const now = Date.now(), stepMs = 60000;

          if (chartType === 'gauge') {
            const greenMax = parseFloat($('#gaugeGreen').val()) || 33;
            const yellowMax = parseFloat($('#gaugeYellow').val()) || 66;
            const yellowMin = greenMax;
            const redMin = yellowMax;

            Highcharts.chart('customChartPreview', {
              chart: { type: 'gauge', plotBorderWidth: 0, height: '50%' },
              title: { text: 'Speedometer' },
              pane: { startAngle: -90, endAngle: 89.9, background: null, center: ['50%', '55%'], size: '100%' },
              yAxis: {
                min: 0, max: 100,
                tickPosition: 'inside',
                labels: { distance: 20, style: { fontSize: '14px' } },
                lineWidth: 0,
                plotBands: [
                  { from: 0, to: greenMax, color: '#55BF3B', thickness: 20 },
                  { from: yellowMin, to: yellowMax, color: '#DDDF0D', thickness: 20 },
                  { from: redMin, to: 200, color: '#DF5353', thickness: 20 }
                ]
              },
              legend: { enabled: $('#show-legend').is(':checked') },
              series: [{
                name: 'Speed',
                data: [Math.floor(Math.random() * 100)],
                tooltip: { valueSuffix: ' km/h' },
                dataLabels: {
                  format: '{y} km/h',
                  style: { fontSize: '16px' }
                },
                dial: { radius: '80%', backgroundColor: 'gray' },
                pivot: { backgroundColor: 'gray', radius: 6 }
              }],
              plotOptions: { gauge: { animation: $('#animated-gauge').is(':checked') } }
            });
          } else {
            const smooth = $('#smooth-line').is(':checked');
            const type = chartType === 'bar' ? 'column' : (smooth ? 'spline' : 'line');
            const series = [];
            $('.series-row').each(function () {
              const name = $(this).find('.series-var').val() || 'Series';
              const color = $(this).find('.series-color').val();
              const style = $(this).find('.series-style').val();
              const axis = parseInt($(this).find('.series-axis').val(), 10);
              const data = Array.from({ length: 10 }, (_, i) => [now + i * stepMs, Math.floor(Math.random() * 100)]);
              series.push({ name, yAxis: axis, color, dashStyle: style, data });
            });
            Highcharts.chart('customChartPreview', {
              chart: { type, zoomType: $('#zoomable').is(':checked') ? 'x' : null },
              title: null,
              xAxis: { type: 'datetime', title: { text: $('#xAxisTitle').val() } },
              yAxis: [
                { title: { text: $('#yAxisTitle').val() || 'Left' } },
                { title: { text: 'Right' }, opposite: true }
              ],
              legend: { enabled: $('#show-legend').is(':checked') },
              plotOptions: {
                series: { animation: $('#animated-linebar').is(':checked') }
              },
              series
            });
          }
        }

        function addSeriesRow() {
          $('#series-inputs').append(`
            <div class="series-row">
              <input type="text" class="form-control series-var" placeholder="Variable name">
              <button class="as-charts-add-var">+</button>
              <select class="form-control series-axis"><option value="0">Left</option><option value="1">Right</option></select>
              <input type="color" class="series-color" value="#7cb5ec">
              <select class="form-control series-style">
                <option>solid</option><option>dash</option><option>dot</option>
              </select>
              <button type="button" class="remove-series-btn">&times;</button>
            </div>
          `);


          $(document).off('click', '.as-charts-add-var')
          $(document).on('click', '.as-charts-add-var', (e) => {
            const input = $(e.currentTarget).closest('.series-row').find('input.series-var')
            $.allskyVariable({
              variable: '',
              valueDiv: '',
              variableSelected: function (variable) {
                $(input).val(variable)
              }
            });
          });

        }

        $(document)
          .on('click', '.chart-type-option', function () {
            $('.chart-type-option').removeClass('active');
            $(this).addClass('active');
            const type = $(this).data('type');
            $('input[name="chartType"]').val(type);
            $('#gaugeOptions').toggle(type === 'gauge');
            $('#lineBarOptions').toggle(type !== 'gauge');
          })
          .on('click', '.remove-series-btn', function () {
            $(this).closest('.series-row').remove();
          });

        $('.wizard-next').click(() => {
          if (!$('input[name="chartType"]').val()) return alert('Please select a chart type first.');
          showStep(step + 1);
        });
        $('.wizard-back').click(() => showStep(step - 1));


        $('.wizard-finish').click(() => {
          const chartType = $('input[name="chartType"]').val();
          const now = Date.now();
          const stepMs = 60000;
          let config;

          if (chartType === 'gauge') {
            const greenMax = parseFloat($('#gaugeGreen').val()) || 33;
            const yellowMax = parseFloat($('#gaugeYellow').val()) || 66;
            const yellowMin = greenMax;
            const redMin = yellowMax;

            config = {
              chart: { type: 'gauge', height: '50%' },
              title: { text: 'Speedometer' },
              pane: {
                startAngle: -90,
                endAngle: 89.9,
                background: null,
                center: ['50%', '55%'],
                size: '100%'
              },
              yAxis: {
                min: 0,
                max: 100,
                tickPosition: 'inside',
                labels: { distance: 20, style: { fontSize: '14px' } },
                lineWidth: 0,
                plotBands: [
                  { from: 0, to: greenMax, color: '#55BF3B', thickness: 20 },
                  { from: yellowMin, to: yellowMax, color: '#DDDF0D', thickness: 20 },
                  { from: redMin, to: 200, color: '#DF5353', thickness: 20 }
                ]
              },
              legend: { enabled: $('#show-legend').is(':checked') },
              series: [{
                name: 'Speed',
                data: [Math.floor(Math.random() * 100)],
                tooltip: { valueSuffix: ' km/h' },
                dataLabels: {
                  format: '{y} km/h',
                  style: { fontSize: '16px' }
                },
                dial: {
                  radius: '80%',
                  backgroundColor: 'gray',
                  baseWidth: 12,
                  baseLength: '0%',
                  rearLength: '0%'
                },
                pivot: {
                  backgroundColor: 'gray',
                  radius: 6
                }
              }],
              plotOptions: {
                gauge: {
                  animation: $('#animated-gauge').is(':checked')
                }
              }
            };
          } else {
            const smooth = $('#smooth-line').is(':checked');
            const type = chartType === 'bar' ? 'column' : (smooth ? 'spline' : 'line');
            const series = [];

            $('.series-row').each(function () {
              const name = $(this).find('.series-var').val() || 'Series';
              const color = $(this).find('.series-color').val();
              const style = $(this).find('.series-style').val();
              const axis = parseInt($(this).find('.series-axis').val(), 10);
              const data = Array.from({ length: 10 }, (_, i) => [now + i * stepMs, Math.floor(Math.random() * 100)]);
              series.push({ name, yAxis: axis, color, dashStyle: style, data });
            });

            config = {
              chart: {
                type,
                zoomType: $('#zoomable').is(':checked') ? 'x' : null
              },
              title: null,
              xAxis: {
                type: 'datetime',
                title: { text: $('#xAxisTitle').val() }
              },
              yAxis: [
                { title: { text: $('#yAxisTitle').val() || 'Left' } },
                { title: { text: 'Right' }, opposite: true }
              ],
              legend: { enabled: $('#show-legend').is(':checked') },
              plotOptions: {
                series: {
                  animation: $('#animated-linebar').is(':checked')
                }
              },
              series
            };
          }

          const configJson = JSON.stringify(config, null, 2);
          settings.onFinish(configJson);
          $('#customChartModal').modal('hide');
        });







        $('.step-tab').click(function () {
          const targetStep = parseInt($(this).data('step'), 10);
          if (targetStep <= step) showStep(targetStep);
        });

        $('#add-series-btn').click(() => addSeriesRow());
        $('#zoomable, #animated-linebar, #animated-gauge, #show-legend, #smooth-line, #gaugeGreen, #gaugeYellow').on('change', generatePreview);

        // Launch modal
        $('<button class="btn btn-primary">Launch Wizard</button>')
          .appendTo($container)
          .click(() => {
            $('#customChartModal').modal('show');
            showStep(1);
            $('#series-inputs').empty();
            addSeriesRow();
            $('input[name="chartType"]').val('');
            $('.chart-type-option').removeClass('active');
          });

        return this;
      };
    })(jQuery);
  </script>

  <div id="wizard"></div>
  <script>
    $('#wizard').chartWizard({
      onFinish: function (configJson) {
        console.log("User's final chart config:", configJson);
      }
    });
  </script>
</body>

</html>