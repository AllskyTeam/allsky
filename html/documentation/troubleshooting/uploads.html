<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="../js/documentation.js" type="application/javascript"></script>
	<link href="../css/light.css" rel="stylesheet">
	<link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="../bower_components/jquery/dist/jquery.min.js"></script>
	<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<style>
		#pageTitle::before {
			content: "Troubleshooting Upload Problems";
		} 
	</style>
	<link href="../css/documentation.css" rel="stylesheet">
	<link href="../documentation-favicon.ico" rel="shortcut icon" type="image/png">
	<script src="../js/all.min.js" type="application/javascript"></script>
	<title>Upload Problems</title>
</head>
<body>
<div w3-include-html="/documentation/pageHeader.html" id="pageHeader"></div>
<div class="Layout">
<div class="Layout-sidebar" w3-include-html="/documentation/sidebar.html" id="sidebar"></div>
<div class="Layout-main markdown-body" id="mainContents">

<p>
<b>Uploading</b> a file means copying it to a different computer.
Allsky supports several ways to upload files including
<code>ftp</code>, <code>scp</code>, and others.
</p>

<p>
After you've configured settings for a remote Website or remote server such as
<span class="WebUISetting">Server Name</span>
and
<span class="WebUISetting">Protocol</span>,
run one of the commands below, depending on whether you are testing uploads
to a remote Allsky Website or a remote server:
<pre>
testUpload.sh --website
<span class="pl-c"> &nbsp; &nbsp; OR</span>
testUpload.sh --server
</pre>

This attempts to upload a test file and if it fails,
it tries to determine why it failed and display what to do to fix it.
</p>
<p>
If that doesn't help, look at the sections below for additional information.
Uploads can fail for many reasons.
The most common ones are described below, as well as their fixes.
</p>

<h3>Incorrect WebUI settings or URL mapping</h3>
<details><summary></summary>
<blockquote>
Most people use <code>ftp</code> or <code>sftp</code> to transfer files to another machine,
so this section will assume that.
The term "remote website" means a website not on your Pi,
but on a remote server, possibly one you pay for services on.
</blockquote>
<p>
The <span class="WebUISetting">Server Name</span>,
<span class="WebUISetting">User Name</span>,
and <span class="WebUISetting">Password</span>
settings in WebUI must be correct.
If you can't log into to your remote server with that information,
Allsky won't be able to either.
Single quotes in the password can cause a problem for Allsky.
</p>
<p>
The directory structure on your FTP server must match the Allsky standard;
changing locations and/or names of files and directories on the remote Website
will cause uploads to fail.
</p>

<blockquote>
The concept of mapping URLs to file locations on a server is very important,
but not very intuitive to most people.
You may need to read this section multiple times.
</blockquote>
<p>
When you enter a URL into a browser, how does the server know where the file is?
It typically starts looking in the root of the website,
which is specified by the hosting service.
When you go to the WebUI, for example via <b>http://allsky</b>,
the Pi's web server looks in <span class="fileName">~/allsky/html</span>
since that's what the Allsky developers specified as the Pi's web root.
</p>
<p>There are two paths to the file - one via a URL (<b>https://allsky</b>)
and the other via the filesystem on the machine
(<span class="fileName">~/allsky/html</span>).
The web server software maps the URL to a file on a computer.
Sometimes that mapping is easy, and other times it's more difficult.
In both cases, it impacts what you enter into the settings into the
<span class="WebUISetting">Image Directory</span> setting in the WebUI.
</p>

<h4>Easy case - URL matches server directory structure</h4>
<p>
Let's say you have a remote website at <b>https://mysite.com</b>
where you store family photos.
When you FTP into your server you see the family photos.
This means your website URL is also the top-most directory of your remote
server's directory structure, called the "root" 
or <span class="fileName">/</span> directory.
</p>
<p>
<a allsky="true" external="true"
	href="/documentation/installations/AllskyWebsite.html">As recommended</a>,
you create a directory in the root of the remote server called
<span class="fileName">allsky</span> using your FTP client,
and copy all the files from the Allsky Website to that directory.
The URL to your Allsky Website would be <b>https://mysite.com/allsky</b>.
In the WebUI set
<span class="WebUISetting">Image Directory</span>
to either <span class="WebUIValue">/allsky</span>
or <span class="WebUIValue">allsky</span>, depending on your service provider.
</p>


<h4>More difficult case - URL does not match directory structure</h4>
<p>
You have the same website as above,
but when you FTP into your server you don't see your family photos;
instead, you see called something like
<span class="fileName">myusername</span>
(the actual directory(s) you see will depend on your service provider).
When you go into the <span class="fileName">myusername</span>
directory you see your photos.
</p>
<p>
In this case the web server is mapping <b>https://mysite.com</b> to its
<span class="fileName">myusername</span> directory.
You need to create a directory on your server
called <span class="fileName">myusername/allsky</span>
and copy the Allsky Website files there.
The URL to the Allsky Website is still <b>https://mysite.com/allsky</b>,
but the <span class="WebUISetting">Image Directory</span> setting
should be <span class="WebUIValue">/myusername/allsky</span>
or <span class="WebUIValue">myusername/allsky</span>.
</p>
<p>
Mapping of URLs to directories like this is fairly common on remote servers that
are shared by many people.
</p>
</details>


<h3>Certificate-related errors</h3>
<details><summary></summary>
<p>
There are three main certificate-related error messages you'll see.
</p>
<ol>
<li><b>Host key verification failed</b> &nbsp; OR
	<br><b>The authenticity of host 'xxxxx' can't be established</b>
	<br>
	These errors typically occur when using the <code>sftp</code> PROTOCOL.
	On the Pi, <code>ssh</code> to your remote server:
	<code>ssh -p 22 username@host</code>
	(replacing "username" and "host" with the appropriate values).
	The host will display a message and prompt for "yes" or "no".
	Enter "yes".
	This only needs to be done once for a given host.
	<br>The remote server now knows about the Pi.

<li><b>Certificate verification: certificate common name doesn't match requested host name "xyz.com"</b>
	<br>
	There are two ways to fix this:
	<ol>
	<li>Create a file called <span class="fileName">~/.lftprc</span> and add
	<code>set ssl:check-hostname false</code> to it:
		<pre>echo "set ssl:check-hostname" &gt; ~/.lftprc</pre>
	<li>Set <span class="WebUISetting">FTP Commands</span> setting
		<code>set ssl:check-hostname false</code>.
     	If you expect to execute <code>lftp</code> manually the first method is better,
		otherwise use the second method so all your configuration changes are in one place.
	</ol>

<li><b>Certificate verification: Not trusted</b>
	<br>
	Add <code>set ssl:verify-certificate no</code> to
	<span class="WebUISetting">FTP Commands</span> or the
	<span class="fileName">~/.lftprc</span> file as above.
</ol>
If your Pi's IP address changed, or the IP address remained but the
machine using the addressed changed, you probably need to remove the previous key from your
<span class="fileName">~/.ssh/known_hosts</span> file.
If the file has only one entry, simply remove it.
If the file has multiple entries, make a backup of the file,
then delete one entry at a time until you find the "bad" one.
</details>


<h3>Missing directories on the remote Website or server</h3>
<details><summary></summary>
<p>
Review the 
<a allsky="true" external="true"
href="/documentation/installations/AllskyWebsite.html">Allsky Website installation instructions</a>
or the 
<a allsky="true" external="true"
href="/documentation/installations/RemoteServer.html">Remote server installation instructions</a>
to determine how to create the necessary directories.
</p>

</details>


</div><!-- Layout-main -->
</div><!-- Layout -->
</body>
</html>
<script> includeHTML(); </script>
