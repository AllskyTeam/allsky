<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="../js/documentation.js" type="application/javascript"></script>
	<link href="../css/light.css" rel="stylesheet">
	<link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="../bower_components/jquery/dist/jquery.min.js"></script>
	<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<style>
		#pageTitle::before {
			content: "Troubleshooting ASI_ERROR_TIMEOUT";
		} 
	</style>
	<link href="../css/documentation.css" rel="stylesheet">
	<link href="../documentation-favicon.ico" rel="shortcut icon" type="image/png">
	<title>ASI_ERROR_TIMEOUT Troubleshooting</title>
</head>
<body>
<div w3-include-html="/documentation/pageHeader.html" id="pageHeader"></div>
<div class="Layout">
<div class="Layout-sidebar" w3-include-html="/documentation/sidebar.html" id="sidebar"></div>
<div class="Layout-main markdown-body" id="mainContents">

<p>
If images are not being taken with your ZWO camera and you see many
<b>ASI_ERROR_TIMEOUT</b> messages in the <span class="fileName">/var/log/allsky.log</span> file,
try the steps below.
The exact reason for these messages is unclear,
although it's often due to incorrect USB settings or excessive voltage drop going
to the Pi or the camera.
Long or thin wires can cause a voltage drop big enough that the camera has problems
producing an image.
</p>
<p>
Additionally, some cameras have buggy firmware that causes image acquisition to fail,
even when other operations succeed.
This condition may persist through a restart of Allsky.
</p>
<p>
If you are seeing lots of ASI_ERROR_TIMEOUT messages
(an occasional one can be ignored) try the following, in this order:
<ol>
<li>If you have easy access to your Pi:
	<ul>
	<li>Check if there is moisture or water in it and if so, let it dry out for a couple days.
		This solved weird problems for some people,
		such as 60 second exposures finishing in 2 seconds,
		and continual ASI_ERROR_TIMEOUT messages.
	<li>Unplug and replug the camera to fully reboot it.
	<li>Move the camera to a different port or from a USB 2 port to USB 3 or vice versa. 
	</ul>
<li>If you don't have easy access to the Pi <b>and you have the <code>uhubctl</code>
	command installed on your Pi</b>, make sure you set the
	<span class="shSetting">UHUBCTL_PATH</span> and <span class="shSetting">UHUBCTL_PORT</span>
	settings in the <span class="fileName">config.sh</span> file, then restart Allsky.
	The next time it fails due to ASI_ERROR_TIMEOUT errors it will reset the USB bus in an
	attempt to fix those errors.  
	You can get the <code>uhubctl</code> command by executing
	<code>sudo apt-get install uhubctl</code>.
<li>Change the USB settings.
	In the WebUI, click on the <b>Camera Settings</b> link and look for the
	<span class="WebUISetting">USB Bandwidth</span> setting.
	Try increasing and decreasing it, and try turning
	<span class="WebUISetting">Auto USB Bandwidth</span> on and off.
	You will have to click on the
	<img allsky="true" class="buttonIconLarge" src="/documentation/img/showAdvancedOptionsButton.png">
	button at the bottom of the page in order to view the USB options.
<li>See if the system is in under-voltage mode or is throttling which
	could lead to insufficient power getting to the camera.
	In the WebUI, go to the <b>System</b> page;
	it will display the throttle and under voltage status.
    If you are getting under-voltage,
	<a href="https://lifepo4wered.com/lifepo4wered-pi.html">this power unit</a> may help.
	Or use a more powerful power supply or power cables with thicker wires.
<li>If you have easy access to your Pi and have a spare powered USB hub,
	plug the hub into your Pi and a power source, and plug the camera into the hub.
	This will usually resolve any power issues with the camera.
<li>If you have a Windows PC, plug the camera into it and use the ZWO software
	that came with the camera to see if it also has problems.
	If it does, it's likely a hardware issue.
<li>Revert to the pre-0.8 exposure method.
	In the WebUI, click on the <b>Camera Settings</b> link.
	At the bottom of the page click on the
	<img allsky="true" class="buttonIconLarge" src="/documentation/img/showAdvancedOptionsButton.png">
	button and look for the <span class="WebUISetting">Version 0.8 Exposure</span> setting
	and toggle it then click on the
	<img allsky="true" class="buttonIcon" src="/documentation/img/saveChangesButton.png">
	button.
<li>The above changes work for almost everyone.
	If they don't work for you, follow the instructions on the
	<a allsky="true" href="/documentation/troubleshooting/reportingIssues.html">Reporting Issues</a>
	Wiki page to report the problem.
</ol>

<h3>IGNORE THESE NOTES FOR NOW:</h3>
<p>
Try adding <code>swiotlb=131072</code> to end of the line in
<span class="fileName">/boot/cmdline.txt</span>, then reboot.  
This increases the number of USB buffers from 32 to 128 and
might be needed for cameras with very large sensors like the ASI294MM (8288 x 5644) @ 16 bits.
<pre>
32  buffers * 1024 bytes/buffer =  32768 bytes.
128 buffers * 1024 bytes/buffer = 131072 bytes.  
</pre>
Prior to this change the contents of
<span class="fileName">/sys/kernel/debug/swiotlb/io_tlb_used</span>
was hitting the maximum of 32768 bytes.
After the change it was hitting a maximum of about 46000.
</p>
<p>
Enable <code>DebugPrint</code> in <span class="fileName">~/.ZWO/ASIconfig.xml</span>
by changing the <code>00</code> to <code>01</code>, then restart Allsky.
A LOT of lines will be added to <span class="fileName">/var/log/allsky.log</span>,
so be sure to set it back to <code>00</code> when done testing.
The extra log entries may offer some insight into causes of the exposure failures.
</p>


</div><!-- Layout-main -->
</div><!-- Layout -->
</body>
</html>
<script> includeHTML(); </script>

