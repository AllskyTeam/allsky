<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Responsive Konva Drawing Tool with Dark Area Brightness</title>
    <!-- Bootstrap 3 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <!-- Font Awesome Free -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 3 JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- KonvaJS -->
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.5/konva.min.js"></script>

    <link rel="stylesheet" href="/js/bootstrap-slider/dist/css/bootstrap-slider.css">
    <script src="/js/bootstrap-slider/dist/bootstrap-slider.js"></script>


    <style>
      /* All CSS scoped within #allsky-mask */
      #allsky-mask .modal-dialog {
        width: 70%;
      }
      #allsky-mask .modal-content {
        display: flex;
        flex-direction: column;
        height: 75vh;
      }
      #allsky-mask .modal-body {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        padding: 0;
      }
      /* Toolbar styling */
      #allsky-mask #allsky-mask-toolbar {
        flex: 0 0 auto;
        padding: 10px;
        background: #eee;
        border-bottom: 1px solid #ccc;
      }
      #allsky-mask #allsky-mask-container {
        flex: 1 1 auto;
        border: 1px solid #ccc;
        width: 100%;
      }
      #allsky-mask .dropdown,
      #allsky-mask .allsky-mask-tool-button {
        margin-right: 5px;
      }
      #allsky-mask label {
        margin-right: 10px;
      }
    </style>
    <script>
      // Custom filter: Only brighten dark areas.
      Konva.Filters.DarkAreaBrighten = function(imageData) {
        var brightness = this.brightness(); // expected value in 0..1
        var data = imageData.data;
        var threshold = 128;
        var addValue = brightness > 0 ? brightness * 100 : 0;
        for (var i = 0; i < data.length; i += 4) {
          var avg = (data[i] + data[i+1] + data[i+2]) / 3;
          if (avg < threshold) {
            data[i] = Math.min(255, data[i] + addValue);
            data[i+1] = Math.min(255, data[i+1] + addValue);
            data[i+2] = Math.min(255, data[i+2] + addValue);
          }
        }
      };
    </script>
  </head>
  <body>
    <div id="allsky-mask">
      <!-- Button to open modal -->
      <div class="container">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#allsky-mask-drawingModal">
          Open Drawing Tool
        </button>
      </div>
    
      <!-- Modal -->
      <div class="modal fade" id="allsky-mask-drawingModal" tabindex="-1" role="dialog" aria-labelledby="allsky-mask-drawingModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span>&times;</span>
              </button>
              <h4 class="modal-title" id="allsky-mask-drawingModalLabel">Konva Drawing Tool</h4>
            </div>
            <div class="modal-body">
              <!-- Toolbar: Dropdown for tool selection plus mode/action buttons and sliders -->
              <div id="allsky-mask-toolbar">
                <button class="allsky-mask-tool-button btn btn-default" id="allsky-mask-newBtn"><i class="fa-solid fa-file"></i></button>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-default active" id="allsky-mask-easyModeBtn">Easy</button>
                  <button type="button" class="btn btn-default" id="allsky-mask-expertModeBtn">Expert</button>
                </div>                
                <!-- Dropdown for expert mode drawing tool selection -->
                <div class="dropdown" style="display:inline-block;">
                  <button id="drawingToolDropdown" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="fas fa-brush"></i> <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu">
                    <!-- For freehand and feather, we show the text but will update the button to show a brush icon -->
                    <li><a href="#" data-tool="freehand"><i class="fas fa-brush"></i></a></li>
                    <li><a href="#" data-tool="feather"><i class="fa-solid fa-feather"></i></a></li>
                    <li><a href="#" data-tool="square"><i class="fa-solid fa-square"></i></a></li>
                    <li><a href="#" data-tool="filledPath"><i class="fa-solid fa-draw-polygon"></i></a></li>
                    <li><a href="#" data-tool="circle"><i class="fa-solid fa-circle"></i></a></li>
                  </ul>
                </div>
                <button class="allsky-mask-tool-button btn btn-default" id="allsky-mask-undoBtn"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="allsky-mask-tool-button btn btn-default" id="allsky-mask-redoBtn"><i class="fa-solid fa-rotate-right"></i></button>
                <!-- Sliders -->

                <div class="dropdown ml-3"  style="display:inline-block;">
                  <button class="btn btn-default dropdown-toggle navbar-btn" type="button" data-toggle="dropdown">
                    <i class="fa-solid fa-filter"></i>
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu allsky-mask-brush-dropdown-background">
                    <li class="ml-4 mr-4">
                      <input type="text" id="allsky-mask-opacitySlider" type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="100" />
                    </li>
                  </ul>
                </div>	


                <div class="dropdown ml-3"  style="display:inline-block;">
                  <button class="btn btn-default dropdown-toggle navbar-btn" type="button" data-toggle="dropdown">
                    <i class="fa-solid fa-lightbulb"></i>
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu allsky-mask-brush-dropdown-background">
                    <li class="ml-4 mr-4">
                      <input type="text" id="allsky-mask-brightnessSlider" type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.1" data-slider-value="0" />
                    </li>
                  </ul>
                </div>	                


                <div class="dropdown ml-3"  style="display:inline-block;">
                  <button class="btn btn-default dropdown-toggle navbar-btn" type="button" data-toggle="dropdown">
                    <i class="fa-solid fa-expand"></i>
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu allsky-mask-brush-dropdown-background">
                    <li class="ml-4 mr-4">
                      <input type="text" id="allsky-mask-brushSizeSlider" type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="10" />
                    </li>
                  </ul>
                </div>	   

                <div class="dropdown ml-3"  style="display:inline-block;">
                  <button class="btn btn-default dropdown-toggle navbar-btn" type="button" data-toggle="dropdown">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu allsky-mask-brush-dropdown-background">
                    <li class="ml-4 mr-4">
                      <input type="text" id="allsky-mask-zoomSlider" type="text" data-slider-min="0.5" data-slider-max="3" data-slider-step="0.05" data-slider-value="1" />
                    </li>
                  </ul>
                </div>	   

              </div>
              <!-- Drawing container -->
              <div id="allsky-mask-container"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" id="allsky-mask-saveBtn">Save</button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    
      <script>
        $(document).ready(function(){
          // Global Konva variables.
          var stage, drawingLayer, drawnGroup, transformer;
          var imageScaleFactor = 1, displayedImageWidth = 0, originalImageWidth = 0, originalImageHeight = 0;
  
          // Global drawing variables.
          // currentTool: "freehand", "feather", "square", "filledPath", "circle"
          mode = "easy";
          currentTool = "circle";
          var isDrawing = false;
          var currentLine, currentShape, startPos;
          var easyCircle = null;
  
          /*$("#allsky-mask-brushSizeSlider").on("input", function(){
            brushSize = parseInt($(this).val(), 10);
          });*/
  
          $('#allsky-mask-brushSizeSlider').slider({
				      value: 10
			      }).on('slide', (e) => {
              brushSize = parseInt(e.value, 10);
			      })	
            var brushSize = parseInt($("#allsky-mask-brushSizeSlider").slider('getValue'), 10);
            
            
          // Dropdown event for selecting drawing tool (expert mode).
          $("#drawingToolDropdown").next(".dropdown-menu").on("click", "a", function(e){
            e.preventDefault();
            var tool = $(this).data("tool");
            currentTool = tool;
 
            // If the selected tool is freehand or feather, update button to show brush icon.
            if (tool === "freehand") {
              $("#drawingToolDropdown").html('<i class="fas fa-brush"></i> <span class="caret"></span>');
            }
            if (tool === "feather") {
              $("#drawingToolDropdown").html('<i class="fas fa-feather"></i> <span class="caret"></span>');
            }
            if (tool === "square") {
              $("#drawingToolDropdown").html('<i class="fas fa-square"></i> <span class="caret"></span>');
            }
            if (tool === "circle") {
              $("#drawingToolDropdown").html('<i class="fas fa-circle"></i> <span class="caret"></span>');
            }
            if (tool === "filledPath") {
              $("#drawingToolDropdown").html('<i class="fas fa-draw-polygon"></i> <span class="caret"></span>');
            }

          });
  
          // Mode button group handling.
          $("#allsky-mask-easyModeBtn").click(function(){
            mode = "easy";
            currentTool = "circle"; // Easy mode forces a circle.
            $(this).addClass("active");
            $("#allsky-mask-expertModeBtn").removeClass("active");
          });
          $("#allsky-mask-expertModeBtn").click(function(){
            mode = "expert";
            $(this).addClass("active");
            $("#allsky-mask-easyModeBtn").removeClass("active");
          });
  
          // New button resets all drawings.
          $("#allsky-mask-newBtn").click(function(){
            drawnGroup.destroyChildren();
            drawnObjects = [];
            undoneObjects = [];
            drawingLayer.draw();
            // In easy mode, also reset the circle.
            easyCircle = null;
          });
  
          // Undo/Redo arrays.
          var drawnObjects = [];
          var undoneObjects = [];
  
          $("#allsky-mask-undoBtn").click(function(){
            // Disable undo in easy mode.
            if (mode === "easy") return;
            if (drawnObjects.length > 0) {
              var node = drawnObjects.pop();
              node.remove();
              undoneObjects.push(node);
              drawingLayer.draw();
            }
          });
  
          $("#allsky-mask-redoBtn").click(function(){
            if (mode === "easy") return;
            if (undoneObjects.length > 0) {
              var node = undoneObjects.pop();
              drawnGroup.add(node);
              drawnObjects.push(node);
              drawingLayer.draw();
            }
          });
  
          $("#allsky-mask-saveBtn").click(function(){
            transformer.hide();
            drawingLayer.opacity(1);
            drawingLayer.draw();
            var pixelRatio = 1 / imageScaleFactor;
            var dataURL = drawingLayer.toDataURL({
              pixelRatio: pixelRatio,
              x: 0,
              y: 0,
              width: stage.width(),
              height: stage.height(),
              backgroundColor: "transparent"
            });
            transformer.show();
            drawingLayer.draw();
            var tempCanvas = document.createElement("canvas");
            tempCanvas.width = originalImageWidth;
            tempCanvas.height = originalImageHeight;
            var ctx = tempCanvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            var drawingImg = new Image();
            drawingImg.onload = function(){
              ctx.drawImage(drawingImg, 0, 0, originalImageWidth, originalImageHeight);
              var finalDataURL = tempCanvas.toDataURL();
              $("<img>").attr("src", finalDataURL).css({
                "max-width": "100%",
                "display": "block",
                "margin": "10px auto"
              }).appendTo("body");
            };
            drawingImg.src = dataURL;
          });
  
          function getTransformedPointerPosition(){
            var pos = stage.getPointerPosition();
            var scale = stage.scaleX(); // assuming uniform scaling
            return { x: pos.x / scale, y: pos.y / scale };
          }
  
          $("#allsky-mask-drawingModal").on("shown.bs.modal", function(){
            var container = document.getElementById("allsky-mask-container");
            var rect = container.getBoundingClientRect();
            var containerWidth = rect.width;
            var containerHeight = rect.height;
  
            stage = new Konva.Stage({
              container: "allsky-mask-container",
              width: containerWidth,
              height: containerHeight
            });
  
            var imageLayer = new Konva.Layer();
            drawingLayer = new Konva.Layer();
            stage.add(imageLayer);
            stage.add(drawingLayer);
  
            drawnGroup = new Konva.Group({ id: "allsky-mask-drawnGroup" });
            drawingLayer.add(drawnGroup);
  
            transformer = new Konva.Transformer();
            drawingLayer.add(transformer);
  
            var imageObj = new Image();
            imageObj.onload = function(){
              originalImageWidth = imageObj.naturalWidth;
              originalImageHeight = imageObj.naturalHeight;
              imageScaleFactor = Math.min(containerWidth / originalImageWidth, containerHeight / originalImageHeight);
              displayedImageWidth = originalImageWidth * imageScaleFactor;
              var displayedImageHeight = originalImageHeight * imageScaleFactor;
  
              stage.width(displayedImageWidth);
              stage.height(displayedImageHeight);
  
              var konvaImage = new Konva.Image({
                image: imageObj,
                x: 0,
                y: 0,
                width: displayedImageWidth,
                height: displayedImageHeight,
                draggable: false
              });
              konvaImage.filters([Konva.Filters.DarkAreaBrighten]);
              konvaImage.brightness(0);
              konvaImage.cache({ x: 0, y: 0, width: displayedImageWidth, height: displayedImageHeight });
              konvaImage.listening(false);
              imageLayer.add(konvaImage);
              imageLayer.draw();
  
              $("#allsky-mask .modal-dialog").css("width", displayedImageWidth + "px");
  
              setTimeout(function(){
                var newRect = container.getBoundingClientRect();
                var newWidth = newRect.width;
                var newHeight = newRect.height;
                imageScaleFactor = Math.min(newWidth / originalImageWidth, newHeight / originalImageHeight);
                displayedImageWidth = originalImageWidth * imageScaleFactor;
                var newDisplayedHeight = originalImageHeight * imageScaleFactor;
                stage.width(displayedImageWidth);
                stage.height(newDisplayedHeight);
                konvaImage.width(displayedImageWidth);
                konvaImage.height(newDisplayedHeight);
                konvaImage.cache({ x: 0, y: 0, width: displayedImageWidth, height: newDisplayedHeight });
                imageLayer.batchDraw();
              }, 100);
            };
            imageObj.onerror = function(){
              console.error("Error loading image at /current/tmp/i.jpg");
            };
            imageObj.src = "/current/tmp/i.jpg?noCache=" + new Date().getTime();
  
            $("#allsky-mask-zoomSlider").on("input", function(){
              var newScale = parseFloat($(this).val());
              stage.scale({ x: newScale, y: newScale });
              stage.batchDraw();
            });
  
            $('#allsky-mask-zoomSlider').slider({
				      value: 1
			      }).on('slide', (e) => {
              var newScale = parseFloat(e.value);
              stage.scale({ x: newScale, y: newScale });
              stage.batchDraw();
			      })	
            
            
            stage.on("wheel", function(e){
              e.evt.preventDefault();
              var oldScale = stage.scaleX();
              var scaleBy = 1.05;
              var newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
              stage.scale({ x: newScale, y: newScale });
              $("#allsky-mask-zoomSlider").val(newScale);
              stage.batchDraw();
            });
  
            /*$("#allsky-mask-brightnessSlider").on("input", function(){
              var value = parseFloat($(this).val());
              var bgImage = imageLayer.findOne("Image");
              if(bgImage){
                bgImage.brightness(value);
                bgImage.cache({ x: 0, y: 0, width: displayedImageWidth, height: stage.height() });
                imageLayer.batchDraw();
              }
            });*/
  
            $('#allsky-mask-brightnessSlider').slider({
				      value: 0
			      }).on('slide', (e) => {
              var value = parseFloat(e.value);
              var bgImage = imageLayer.findOne("Image");
              if(bgImage){
                bgImage.brightness(value);
                bgImage.cache({ x: 0, y: 0, width: displayedImageWidth, height: stage.height() });
                imageLayer.batchDraw();
              }
			      })	


            $('#allsky-mask-opacitySlider').slider({
				      value: 0
			      }).on('slide', (e) => {
              var opac = parseFloat(e.value)/100;
              console.log(opac)
              drawingLayer.opacity(opac);
              drawingLayer.draw();
			      })	

           /* $("#allsky-mask-opacitySlider").on("input", function(){
              var opac = parseFloat($(this).val());
              drawingLayer.opacity(opac);
              drawingLayer.draw();
            });*/
  
            // Separate event handling for easy and expert modes.
            stage.on("mousedown touchstart", function(e){
              if(mode === "easy"){
                // In easy mode, only allow a single circle.
                if(e.target === stage){
                  if(!easyCircle){
                    var circle = new Konva.Circle({
                      x: stage.width()/2,
                      y: stage.height()/2,
                      radius: 50,
                      fill: "white",
                      draggable: true
                    });
                    drawnGroup.add(circle);
                    transformer.nodes([circle]);
                    drawingLayer.draw();
                    drawnObjects.push(circle);
                    easyCircle = circle;
                  } else {
                    transformer.nodes([easyCircle]);
                    drawingLayer.draw();
                  }
                }
                return;
              }
  
              if(mode === "expert"){
                isDrawing = true;
                startPos = getTransformedPointerPosition();
                switch(currentTool){
                  case "freehand":
                  case "feather":
                    currentLine = new Konva.Line({
                      stroke: "white",
                      strokeWidth: currentTool === "feather" ? brushSize * 2 : brushSize,
                      lineCap: "round",
                      lineJoin: "round",
                      points: [startPos.x, startPos.y]
                    });
                    currentLine.setAttr("brushType", currentTool);
                    drawnGroup.add(currentLine);
                    break;
                  case "square":
                    currentShape = new Konva.Rect({
                      x: startPos.x,
                      y: startPos.y,
                      width: 0,
                      height: 0,
                      stroke: "white",
                      strokeWidth: 2
                    });
                    drawnGroup.add(currentShape);
                    break;
                  case "filledPath":
                    currentLine = new Konva.Line({
                      stroke: "white",
                      strokeWidth: 2,
                      closed: false,
                      points: [startPos.x, startPos.y]
                    });
                    drawnGroup.add(currentLine);
                    break;
                  case "circle":
                    currentShape = new Konva.Circle({
                      x: startPos.x,
                      y: startPos.y,
                      radius: 0,
                      stroke: "white",
                      strokeWidth: 2,
                      fill: "white"
                    });
                    drawnGroup.add(currentShape);
                    break;
                }
              }
            });
  
            stage.on("mousemove touchmove", function(e){
              if(!isDrawing) return;
              var pos = getTransformedPointerPosition();
              if(mode === "expert"){
                if(currentTool === "freehand" || currentTool === "feather"){
                  var newPoints = currentLine.points().concat([pos.x, pos.y]);
                  currentLine.points(newPoints);
                  drawingLayer.batchDraw();
                } else if(currentTool === "square"){
                  currentShape.width(pos.x - startPos.x);
                  currentShape.height(pos.y - startPos.y);
                  drawingLayer.batchDraw();
                } else if(currentTool === "filledPath"){
                  var newPoints = currentLine.points().concat([pos.x, pos.y]);
                  currentLine.points(newPoints);
                  drawingLayer.batchDraw();
                } else if(currentTool === "circle"){
                  var dx = pos.x - startPos.x;
                  var dy = pos.y - startPos.y;
                  var newRadius = Math.sqrt(dx * dx + dy * dy);
                  currentShape.radius(newRadius);
                  drawingLayer.batchDraw();
                }
              }
            });
  
            stage.on("mouseup touchend", function(){
              if(isDrawing && mode === "expert"){
                if(currentTool === "filledPath" && currentLine){
                  currentLine.closed(true);
                  currentLine.fill("white");
                  drawingLayer.draw();
                  drawnObjects.push(currentLine);
                }
                if(currentTool === "square" && currentShape){
                  currentShape.fill("white");
                  drawingLayer.draw();
                  drawnObjects.push(currentShape);
                }
                if(currentTool === "circle" && currentShape){
                  drawingLayer.draw();
                  drawnObjects.push(currentShape);
                }
                if((currentTool === "freehand" || currentTool === "feather") && currentLine){
                  if(currentTool === "feather"){
                    currentLine.filters([Konva.Filters.Blur]);
                    currentLine.blurRadius(3);
                    currentLine.cache();
                  }
                  drawingLayer.draw();
                  drawnObjects.push(currentLine);
                }
              }
              isDrawing = false;
              currentLine = null;
              currentShape = null;
            });
  
            drawingLayer.draw();
          });
        });
  
        function getTransformedPointerPosition(){
          var pos = stage.getPointerPosition();
          var scale = stage.scaleX();
          return { x: pos.x / scale, y: pos.y / scale };
        }
      </script>
    </div>
  </body>
</html>
